root@vultr:~# nano update-from-github.sh
root@vultr:~# chmod +x update-from-github.sh
root@vultr:~# ./update-from-github.sh
╔══════════════════════════════════════════════════════════════╗
║         URL CAMPAIGN TRACKER - GITHUB UPDATE                 ║
╚══════════════════════════════════════════════════════════════╝

📋 CURRENT CONFIGURATION:
🔹 Application directory: /var/www/url-campaign
🔹 Database user: postgres
🔹 Database name: postgres
🔹 PM2 app name: url-campaign
🔹 GitHub repo: https://github.com/rijwanmirza/UrlCampaignTracker.git
🔹 Backup directory: /root/url-campaign-backup-20250428061606

Is this configuration correct? (y/n): y
Starting update process...

📦 Creating backup of the current application...
✓ Application backed up to /root/url-campaign-backup-20250428061606
🗃️ Creating database backup...
✓ Database backup created at /root/url-campaign-backup-20250428061606/database-20250428061617.sql
🛑 Stopping application...
[PM2] Applying action stopProcessId on app [url-campaign](ids: [ 0 ])
[PM2] [url-campaign](0) ✓
┌────┬─────────────────┬─────────────┬─────────┬─────────┬──────────┬────────┬──────┬───────────┬──────────┬──────────┬──────────┬──────────┐
│ id │ name            │ namespace   │ version │ mode    │ pid      │ uptime │ ↺    │ status    │ cpu      │ mem      │ user     │ watching │
├────┼─────────────────┼─────────────┼─────────┼─────────┼──────────┼────────┼──────┼───────────┼──────────┼──────────┼──────────┼──────────┤
│ 0  │ url-campaign    │ default     │ 1.0.0   │ fork    │ 0        │ 0      │ 5    │ stopped   │ 0%       │ 0b       │ root     │ disabled │
└────┴─────────────────┴─────────────┴─────────┴─────────┴──────────┴────────┴──────┴───────────┴──────────┴──────────┴──────────┴──────────┘
✓ Application stopped
📥 Cloning the latest code from GitHub...
Cloning into '/tmp/url-campaign-update-20250428061619'...
remote: Enumerating objects: 3298, done.
remote: Counting objects: 100% (3298/3298), done.
remote: Compressing objects: 100% (1100/1100), done.
remote: Total 3298 (delta 2231), reused 3214 (delta 2147), pack-reused 0 (from 0)
Receiving objects: 100% (3298/3298), 38.09 MiB | 14.26 MiB/s, done.
Resolving deltas: 100% (2231/2231), done.
✓ Repository cloned successfully
📋 Preserving configuration files...
Copying .env
Copying gmail_config.json
Copying gmail_credentials.json
Copying gmail_token.json
✓ Configuration files preserved
📦 Installing dependencies...
npm warn deprecated @esbuild-kit/esm-loader@2.6.5: Merged into tsx: https://tsx.is
npm warn deprecated @esbuild-kit/core-utils@3.3.2: Merged into tsx: https://tsx.is

added 632 packages, and audited 633 packages in 23s

78 packages are looking for funding
  run `npm fund` for details

15 vulnerabilities (8 moderate, 3 high, 4 critical)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
✓ Dependencies installed
🔨 Building application...

> rest-express@1.0.0 build
> vite build && esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist

vite v5.4.14 building for production...
transforming (5) ../node_modules/wouter/esm/index.jsBrowserslist: browsers data (caniuse-lite) is 6 months old. Please run:
  npx update-browserslist-db@latest
  Why you should do it regularly: https://github.com/browserslist/update-db#readme
✓ 2227 modules transformed.
../dist/public/index.html                   2.02 kB │ gzip:   0.86 kB
../dist/public/assets/index-B46m0Riv.css   66.26 kB │ gzip:  11.50 kB
../dist/public/assets/index-BIIX2iOl.js   727.60 kB │ gzip: 210.83 kB

(!) Some chunks are larger than 500 kB after minification. Consider:
- Using dynamic import() to code-split the application
- Use build.rollupOptions.output.manualChunks to improve chunking: https://rollupjs.org/configuration-options/#output-manualchunks
- Adjust chunk size limit for this warning via build.chunkSizeWarningLimit.
✓ built in 16.50s
▲ [WARNING] Duplicate member "spentValuePausedCampaigns" in class body [duplicate-class-member]

    server/trafficstar-service.ts:1507:10:
      1507 │   private spentValuePausedCampaigns: Map<number, { pausedAt: Date, recheckAt: Date, disabledThresholdForDate: string }> = new Map();
           ╵           ~~~~~~~~~~~~~~~~~~~~~~~~~

  The original member "spentValuePausedCampaigns" is here:

    server/trafficstar-service.ts:76:10:
      76 │   private spentValuePausedCampaigns: Map<number, {
         ╵           ~~~~~~~~~~~~~~~~~~~~~~~~~

▲ [WARNING] Duplicate member "budgetAdjustedCampaigns" in class body [duplicate-class-member]

    server/trafficstar-service.ts:1514:10:
      1514 │   private budgetAdjustedCampaigns: Map<number, string> = new Map();
           ╵           ~~~~~~~~~~~~~~~~~~~~~~~

  The original member "budgetAdjustedCampaigns" is here:

    server/trafficstar-service.ts:72:10:
      72 │   private budgetAdjustedCampaigns: Map<number, string> = new Map();
         ╵           ~~~~~~~~~~~~~~~~~~~~~~~

2 warnings

  dist/index.js  285.9kb

⚡ Done in 52ms
✓ Build completed
🗃️ Checking for database schema updates...
Found schema.sql, applying changes...
SET
SET
SET
SET
SET
 set_config
------------

(1 row)

SET
SET
SET
SET
ERROR:  type "url_status" already exists
ERROR:  role "neondb_owner" does not exist
SET
SET
CREATE TABLE
ERROR:  role "neondb_owner" does not exist
CREATE SEQUENCE
ERROR:  role "neondb_owner" does not exist
ALTER SEQUENCE
ERROR:  relation "campaigns" already exists
ERROR:  role "neondb_owner" does not exist
ERROR:  relation "campaigns_id_seq" already exists
ERROR:  role "neondb_owner" does not exist
ALTER SEQUENCE
CREATE TABLE
ERROR:  role "neondb_owner" does not exist
ERROR:  relation "trafficstar_campaigns" already exists
ERROR:  role "neondb_owner" does not exist
ERROR:  relation "trafficstar_campaigns_id_seq" already exists
ERROR:  role "neondb_owner" does not exist
ALTER SEQUENCE
ERROR:  relation "trafficstar_credentials" already exists
ERROR:  role "neondb_owner" does not exist
ERROR:  relation "trafficstar_credentials_id_seq" already exists
ERROR:  role "neondb_owner" does not exist
ALTER SEQUENCE
ERROR:  relation "urls" already exists
ERROR:  role "neondb_owner" does not exist
ERROR:  relation "urls_id_seq" already exists
ERROR:  role "neondb_owner" does not exist
ALTER SEQUENCE
CREATE TABLE
ERROR:  role "neondb_owner" does not exist
CREATE SEQUENCE
ERROR:  role "neondb_owner" does not exist
ALTER SEQUENCE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ERROR:  relation "campaigns_custom_path_unique" already exists
ERROR:  multiple primary keys for table "campaigns" are not allowed
ALTER TABLE
ERROR:  multiple primary keys for table "trafficstar_campaigns" are not allowed
ERROR:  relation "trafficstar_campaigns_trafficstar_id_unique" already exists
ERROR:  multiple primary keys for table "trafficstar_credentials" are not allowed
ERROR:  multiple primary keys for table "urls" are not allowed
ALTER TABLE
ALTER TABLE
CREATE INDEX
ERROR:  role "neon_superuser" does not exist
ERROR:  role "neon_superuser" does not exist
Found click_protection.sql, applying changes...
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
DROP TRIGGER
NOTICE:  trigger "prevent_campaign_auto_click_update_trigger" for relation "campaigns" does not exist, skipping
DROP TRIGGER
CREATE TRIGGER
CREATE TRIGGER
Ensuring original_url_records table exists...
NOTICE:  relation "original_url_records" already exists, skipping
CREATE TABLE
NOTICE:  relation "original_url_records_name_idx" already exists, skipping
CREATE INDEX
✓ Database schema checks completed
🛡️ Ensuring click protection is active...
NOTICE:  relation "system_settings" already exists, skipping
CREATE TABLE
INSERT 0 1
CREATE FUNCTION
DROP TRIGGER
CREATE TRIGGER
✓ Click protection ensured
🔄 Replacing old application with new code...
✓ Application files updated
🚀 Starting application...
[PM2] Applying action restartProcessId on app [url-campaign](ids: [ 0 ])
[PM2] [url-campaign](0) ✓
[PM2] Process successfully started
┌────┬─────────────────┬─────────────┬─────────┬─────────┬──────────┬────────┬──────┬───────────┬──────────┬──────────┬──────────┬──────────┐
│ id │ name            │ namespace   │ version │ mode    │ pid      │ uptime │ ↺    │ status    │ cpu      │ mem      │ user     │ watching │
├────┼─────────────────┼─────────────┼─────────┼─────────┼──────────┼────────┼──────┼───────────┼──────────┼──────────┼──────────┼──────────┤
│ 0  │ url-campaign    │ default     │ 1.0.0   │ fork    │ 2385     │ 0      │ 6    │ stopped   │ 0%       │ 0b       │ root     │ disabled │
└────┴─────────────────┴─────────────┴─────────┴─────────┴──────────┴────────┴──────┴───────────┴──────────┴──────────┴──────────┴──────────┘
[PM2] Saving current process list...
[PM2] Successfully saved in /root/.pm2/dump.pm2
✓ Application started
🧹 Cleaning up...
✓ Temporary files removed
╔══════════════════════════════════════════════════════════════╗
║              UPDATE COMPLETED SUCCESSFULLY                   ║
╚══════════════════════════════════════════════════════════════╝

The URL Campaign Tracker has been updated from GitHub.
Features included in this update:
✓ Click protection to prevent automatic click quantity changes
✓ Original URL Records feature for master URL data management
✓ Unlimited click quantity validation (limits removed)

If you encounter any issues:
1. Check PM2 logs: pm2 logs url-campaign
2. Restore from backup: cp -r /root/url-campaign-backup-20250428061606/* /var/www/url-campaign/
3. Restore database: sudo -u postgres psql postgres < /root/url-campaign-backup-20250428061606/database-20250428061617.sql

Backup files:
- Application: /root/url-campaign-backup-20250428061606
- Database: /root/url-campaign-backup-20250428061606/database-20250428061617.sql
root@vultr:~#
